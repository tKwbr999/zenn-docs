---
title: 'Supabase Edge Functions é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †'
emoji: 'ğŸ”§'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [supabase, edgefunctions, playwright, e2etest]
published: true
---

## ã¯ã˜ã‚ã«

supabase edge functions ã¯ gcp ã§ã„ã†ã¨ cloud function, aws ã§ã„ã†ã¨ lambda ã®ã‚ˆã†ãªã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚

ä¸€ç•ªã®é•ã„ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã¾ã§ã®æ‰‹é–“ãŒéå¸¸ã«å°‘ãªãã€é–‹ç™ºè€…ä½“é¨“ãŒå„ªã‚Œã¦ã„ã‚‹ç‚¹ã§ã™ã€‚ã¾ãŸã€TypeScript ã®ã‚µãƒãƒ¼ãƒˆãŒå……å®Ÿã—ã¦ãŠã‚Šã€Deno ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã§å®‰å…¨æ€§ã¨é«˜é€Ÿãªå®Ÿè¡Œç’°å¢ƒã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

ãã‚“ãª Supabase Edge Function ã®é–‹ç™ºã‹ã‚‰ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã®ä¸€é€£ã®æ‰‹é †ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ç’°å¢ƒæ§‹ç¯‰ãŒåˆ¥é€”å¿…è¦ãªå ´åˆã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã®ã§ãã®éš›ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©å‚ç…§ã—ã¦é©å®œå¯¾å¿œã®ã»ã©ãŠé¡˜ã„ã—ã¾ã™ã€‚

- TypeScript
- Node.js
- Supabase CLI
- Playwright
- dotenv
- Deno
- GitHub actions

ã‚³ãƒ¼ãƒ‰ã«ã¯å…·ä½“çš„ãª URL ã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ãŒç‰¹ã«ä½•ã‚‚è¨­å®šã—ãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’åŸºã«ã—ã¦ã„ã¾ã™ã®ã§ãã®ã¾ã¾ã‚³ãƒ”ãƒšã—ã¦ã‚‚å‹•ãå†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚

## 1. å‰ææ¡ä»¶

ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

- [Node.js](https://nodejs.org/) (npm ã‚’å«ã‚€)
- [Supabase CLI](https://supabase.com/docs/guides/cli) (ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„)
- [Docker](https://www.docker.com/) (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ä½¿ç”¨)

## 2. é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 2.1. Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚VSCode ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€Deno ã®è¨­å®šã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

```bash
supabase init
# Generate VS Code settings for Deno? [y/N] y
```

### 2.2. npm ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–

```bash
npm init -y
```

### 2.3. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Playwrightã€Node.js ã®å‹å®šç¾©ã€ãŠã‚ˆã³ç’°å¢ƒå¤‰æ•°ã‚’æ‰±ã†ãŸã‚ã® `dotenv` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
npm install --save-dev @playwright/test @types/node dotenv
```

### 2.4. TypeScript è¨­å®š (`tsconfig.json`)

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `tsconfig.json` ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```json
{
  "compilerOptions": {
    "target": "esnext",
    "module": "esnext",
    "moduleResolution": "node",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "types": ["node"]
  },
  "include": [
    "supabase/functions/**/*.ts" // å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
  ],
  "exclude": ["node_modules"]
}
```

### 2.5. Playwright è¨­å®š (`playwright.config.ts`)

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `playwright.config.ts` ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (`baseURL`) ã‚’ç’°å¢ƒå¤‰æ•° `TEST_TARGET` ã§åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```typescript
import { defineConfig, devices } from '@playwright/test';
import dotenv from 'dotenv';

// .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
dotenv.config();

// ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
const testTarget = process.env.TEST_TARGET || 'local'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯local

// baseURLã‚’è¨­å®š
let baseURL;
if (testTarget === 'local') {
  // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (supabase startã§è¡¨ç¤ºã•ã‚Œã‚‹URL)
  baseURL = process.env.SUPABASE_LOCAL_FUNCTIONS_URL || 'http://localhost:54321/functions/v1/';
} else if (testTarget === 'deployed') {
  // ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
  baseURL = process.env.SUPABASE_DEPLOYED_FUNCTIONS_URL;
  if (!baseURL) {
    console.error(
      'Error: SUPABASE_DEPLOYED_FUNCTIONS_URL is not set in .env file for deployed target.'
    );
    process.exit(1); // ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†
  }
} else {
  console.warn(`Warning: Unknown TEST_TARGET "${testTarget}". Defaulting to local.`);
  baseURL = process.env.SUPABASE_LOCAL_FUNCTIONS_URL || 'http://localhost:54321/functions/v1/';
}

export default defineConfig({
  testDir: './supabase/functions/tests', // ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: baseURL, // baseURLã‚’è¨­å®š
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    // å¿…è¦ã«å¿œã˜ã¦ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’è¿½åŠ 
  ],
});
```

### 2.6. Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npx playwright install --with-deps
```

### 2.7. npm ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨­å®š

`package.json` ã® `scripts.test` ã‚’ä¿®æ­£ã—ã¦ã€`npm test` ã§ Playwright ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```json
{
  // ... (ä»–ã®è¨­å®š)
  "scripts": {
    "test": "playwright test"
  }
  // ... (ä»–ã®è¨­å®š)
}
```

### 2.8. ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ« (`.env`) ã®ä½œæˆ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ Git ç®¡ç†ã«å«ã‚ãªã„ã§ãã ã•ã„ã€‚

```dotenv
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ (supabase start ã®å‡ºåŠ›ã‹ã‚‰å–å¾—)
SUPABASE_ANON_KEY=YOUR_LOCAL_SUPABASE_ANON_KEY
SUPABASE_LOCAL_FUNCTIONS_URL=http://localhost:54321/functions/v1/

# ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒ†ã‚¹ãƒˆç”¨ (Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰å–å¾—)
SUPABASE_DEPLOYED_ANON_KEY=YOUR_DEPLOYED_SUPABASE_ANON_KEY
SUPABASE_DEPLOYED_FUNCTIONS_URL=https://<your-project-id>.supabase.co/functions/v1/
```

`YOUR_LOCAL_SUPABASE_ANON_KEY`, `YOUR_DEPLOYED_SUPABASE_ANON_KEY`, `<your-project-id>` ã‚’å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

### 2.9. `.gitignore` ã®æ›´æ–°

`.gitignore` ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã€Git ã®è¿½è·¡å¯¾è±¡ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚

```.gitignore
node_modules
.vscode
.env
test-results/
playwright-report/
```

## 3. Edge Function ã®å®Ÿè£…

### 3.1. é–¢æ•°ä½œæˆ

`<function_name>` ã¨ã„ã†åå‰ã® Edge Function ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
supabase functions new <function_name>
```

ã“ã‚Œã«ã‚ˆã‚Šã€`supabase/functions/<function_name>/index.ts` ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

### 3.2. ã‚³ãƒ¼ãƒ‰å®Ÿè£…

ç”Ÿæˆã•ã‚ŒãŸ `supabase/functions/<function_name>/index.ts` ã‚’é–‹ãã€é–¢æ•°ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```typescript
// ä¾‹: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‹ã‚‰ 'name' ã‚’å—ã‘å–ã‚Šã€æŒ¨æ‹¶ã‚’è¿”ã™é–¢æ•°
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'; // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯é©å®œæ›´æ–°

serve(async (req) => {
  try {
    const { name } = await req.json();
    const data = {
      message: `Hello ${name}!`,
    };

    return new Response(JSON.stringify(data), { headers: { 'Content-Type': 'application/json' } });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 400,
      headers: { 'Content-Type': 'application/json' },
    });
  }
});
```

## 4. ãƒ†ã‚¹ãƒˆã®å®Ÿè£… (Playwright)

### 4.1. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä½œæˆ

`supabase/functions/tests/<function_name>.spec.ts` ã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```typescript
import { test, expect } from '@playwright/test';
import dotenv from 'dotenv';

// .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
dotenv.config();

// Anon Keyã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾— (ãƒ†ã‚¹ãƒˆå¯¾è±¡ã«å¿œã˜ã¦åˆ‡ã‚Šæ›¿ãˆ)
const testTarget = process.env.TEST_TARGET || 'local';
const SUPABASE_ANON_KEY =
  testTarget === 'deployed'
    ? process.env.SUPABASE_DEPLOYED_ANON_KEY
    : process.env.SUPABASE_LOCAL_ANON_KEY;

// é–¢æ•°åã‚’æŒ‡å®š
const functionName = '<function_name>';

// ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼
if (!SUPABASE_ANON_KEY) {
  throw new Error(
    `Anon Key (SUPABASE_${testTarget.toUpperCase()}_ANON_KEY) is not defined. Please check your .env file.`
  );
}

test(`${functionName} function should return a greeting`, async ({ request }) => {
  const name = 'TestUser';
  const response = await request.post(`${functionName}`, {
    // baseURLã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹
    headers: {
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      'Content-Type': 'application/json',
    },
    data: { name: name },
  });

  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
  expect(response.ok()).toBeTruthy();

  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’ç¢ºèª
  const responseBody = await response.json();
  expect(responseBody).toEqual({ message: `Hello ${name}!` });
});

// å¿…è¦ã«å¿œã˜ã¦ä»–ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ 
```

`<function_name>` ã‚’å®Ÿéš›ã®é–¢æ•°åã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

## 5. ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

### 5.1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ

1.  **Supabase ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•:**
    ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã® Supabase ç’°å¢ƒã‚’èµ·å‹•ã—ã¾ã™ã€‚

    ```bash
    supabase start
    ```

    è¡¨ç¤ºã•ã‚Œã‚‹ `API URL` ã¨ `anon key` ã‚’ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã® `SUPABASE_LOCAL_FUNCTIONS_URL` ã¨ `SUPABASE_ANON_KEY` ã«è¨­å®šã—ã¾ã™ã€‚

2.  **ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ:**
    åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

    ```bash
    npm test
    # ã¾ãŸã¯
    TEST_TARGET=local npm test
    ```

3.  **Supabase ã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢:**
    ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ Supabase ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã¾ã™ã€‚

    ```bash
    supabase stop
    ```

### 5.2. ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ

1.  **ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª:**
    `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã® `SUPABASE_DEPLOYED_ANON_KEY` ã¨ `SUPABASE_DEPLOYED_FUNCTIONS_URL` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

2.  **ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ:**
    ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

    ```bash
    TEST_TARGET=deployed npm test
    ```

### 5.3. GitHub Actions ã§ã®ãƒ†ã‚¹ãƒˆã¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ (CI/CD)

GitHub Actions ã‚’ä½¿ç”¨ã—ã¦ã€`main` ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã«è‡ªå‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Pull request æ™‚ã¯ãƒ†ã‚¹ãƒˆã®ã¿ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

1.  **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ:**
    `.github/workflows/test.yml` ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚

    ```yaml
    name: Test and Deploy # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã‚’å¤‰æ›´

    on:
      push:
        branches: [main] # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã®ã¿å®Ÿè¡Œ
      # pull_request: # Pull Requestæ™‚ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãªã„ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤
      #   branches: [ main ]

    jobs:
      test_and_deploy: # ã‚¸ãƒ§ãƒ–åã‚’å¤‰æ›´
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Set up Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '20' # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Install Playwright browsers
            run: npx playwright install --with-deps

          - name: Set up Supabase CLI
            uses: supabase/setup-cli@v1
            with:
              version: latest # ã¾ãŸã¯ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

          - name: Start Supabase services
            run: supabase start

          - name: Run tests
            env:
              SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }} # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ã®Anon Key
              # TEST_TARGET ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ 'local' ãŒä½¿ç”¨ã•ã‚Œã‚‹
            run: npm test

          # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
          - name: Deploy to Supabase
            if: github.ref == 'refs/heads/main'
            env:
              SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }} # Supabaseã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
              SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }} # Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
            # ç‰¹å®šã®é–¢æ•° '<function_name>' ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ (å®Ÿéš›ã®é–¢æ•°åã«ç½®ãæ›ãˆã‚‹)
            run: supabase functions deploy <function_name> --project-ref $SUPABASE_PROJECT_ID

          - name: Stop Supabase services
            if: always() # ãƒ†ã‚¹ãƒˆã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¦ã‚‚å¿…ãšå®Ÿè¡Œ
            run: supabase stop
    ```

    **æ³¨æ„:** ä¸Šè¨˜ YAML å†…ã® `<function_name>` ã¯ã€å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„é–¢æ•°å (ä¾‹: `hello-world`) ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

2.  **Secrets ã®è¨­å®š:**
    GitHub ãƒªãƒã‚¸ãƒˆãƒªã® **Settings** > **Secrets and variables** > **Actions** ã§ã€ä»¥ä¸‹ã® Secrets ã‚’ä½œæˆã—ã¾ã™ã€‚
    - **`SUPABASE_ANON_KEY`**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ã® Anon Key (é€šå¸¸ `supabase start` ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚‚ã®)ã€‚
    - **`SUPABASE_ACCESS_TOKEN`**: Supabase ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ (Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > Account > Access Tokens ã§ç”Ÿæˆ)ã€‚
    - **`SUPABASE_PROJECT_ID`**: ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã® Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID (Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > Project Settings > General settings ã§ç¢ºèª)ã€‚

## 6. ãƒ‡ãƒ—ãƒ­ã‚¤

### 6.1. æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

Supabase CLI ã‚’ä½¿ç”¨ã—ã¦ã€å¯¾è±¡ã®é–¢æ•°ã‚’æ‰‹å‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```bash
supabase functions deploy <function_name> --project-ref <your-project-id>
```

`<function_name>` ã¨ `<your-project-id>` ã‚’å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚`--project-ref` ã¯ã€Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã«å¿…è¦ã§ã™ã€‚ãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¸è¦ã§ã™ (`supabase link --project-ref <your-project-id>`)ã€‚

ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ (`TEST_TARGET=deployed npm test`) ã‚’å®Ÿè¡Œã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚

### 6.2. è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ (GitHub Actions)

ä¸Šè¨˜ã€Œ5.3. GitHub Actions ã§ã®ãƒ†ã‚¹ãƒˆã¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã§è¨­å®šã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šã€`main` ãƒ–ãƒ©ãƒ³ãƒã« push ã•ã‚Œã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆæˆåŠŸå¾Œã«è‡ªå‹•ã§é–¢æ•°ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

## ãŠã‚ã‚Šã«

ç°¡å˜ãªã‚‚ã®ã ã¨æ•°åˆ†ã§ã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‘ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ï¼‘ï¼åˆ†ç¨‹åº¦ã‚ã‚Œã°ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

ç„¡æ–™ã§ã‚‚åˆ©ç”¨ã§ãã¦æ°—æ¥½ã•ã‚‚å…¼ã­å‚™ãˆã¦ã„ã‚‹ã®ã§ã”åˆ©ç”¨ã—ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚
