name: Sync Changed Content with Notion

on:
  push:
    branches:
      - main
    # Trigger only if relevant markdown files are changed
    paths:
      - 'articles/**.md'
      - 'articles/**.mdx'
      - 'books/**.md'
      - 'books/**.mdx'
      - '.github/workflows/notion-sync.yml' # Also trigger if workflow changes
      - '.github/scripts/sync-to-notion.js' # Also trigger if script changes
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    # Prevent running multiple instances concurrently for the same branch
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch entire history to allow changed-files action to compare commits
          fetch-depth: 0
          # Persist credentials for commit back step
          persist-credentials: true

      - name: Get changed Markdown files
        id: changed_files
        uses: tj-actions/changed-files@v44 # Use specific version for stability
        with:
          # Specify the patterns for files to track changes
          files: |
             articles/**.md
             articles/**.mdx
             books/**.md
             books/**.mdx
          # Output format as space-separated string
          files_separator: ' '

      - name: List changed files (for debugging)
        if: steps.changed_files.outputs.any_changed == 'true'
        run: |
          echo "Changed files detected:"
          echo "${{ steps.changed_files.outputs.all_changed_files }}"

      - name: Setup Node.js
        if: steps.changed_files.outputs.any_changed == 'true'
        uses: actions/setup-node@v4 # Use latest LTS Node.js version
        with:
          node-version: '18'
          cache: 'npm' # Cache npm dependencies

      - name: Install dependencies
        if: steps.changed_files.outputs.any_changed == 'true'
        run: npm install @notionhq/client gray-matter @tryfabric/martian dotenv

      - name: Sync changed content with Notion
        id: sync_script
        if: steps.changed_files.outputs.any_changed == 'true'
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_PARENT_ID: ${{ secrets.NOTION_PARENT_ID }}
          # Pass changed files as arguments to the script
        run: node .github/scripts/sync-to-notion.js ${{ steps.changed_files.outputs.all_changed_files }}

      # --- Commit back notionPageId changes ---
      - name: Check for notionPageId changes
        id: git_check
        if: steps.changed_files.outputs.any_changed == 'true' && steps.sync_script.outcome == 'success'
        run: |
          # Check if there are any changes to markdown files after the script ran
          git status --porcelain articles/** books/**
          # Set output based on whether changes exist
          if git diff --quiet articles/** books/**; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit notionPageId updates
        if: steps.git_check.outputs.no_changes == 'false'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add articles/** books/** # Stage potentially modified markdown files
          git commit -m "chore: update notionPageId from sync script [skip ci]"
          echo "Pushing notionPageId changes..."
          git push origin ${{ github.ref_name }} # Push to the same branch
        env:
          # Use GITHUB_TOKEN for push permission if needed, or a PAT
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: No notionPageId changes to commit
        if: steps.git_check.outputs.no_changes == 'true'
        run: echo "No notionPageId changes detected after sync."

      - name: No relevant file changes detected in push
        if: steps.changed_files.outputs.any_changed != 'true'
        run: echo "No relevant Markdown file changes detected in this push. Skipping sync."